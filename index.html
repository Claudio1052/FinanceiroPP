<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Dﾃｭzimos e Ofertas - Verbo da Vida</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* (O CSS permanece exatamente o mesmo que vocﾃｪ forneceu) */
        :root { 
            --primary: #1a4b8c; 
            --primary-light: #2a6fd6; 
            --secondary: #f9c80e; 
            --success: #28a745; 
            --danger: #dc3545; 
            --light: #f8f9fa; 
            --dark: #343a40; 
            --gray: #6c757d; 
            --border: #dee2e6; 
            --accent: #17a2b8;
            --estacao: #9b59b6;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8f9fa; color: var(--dark); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* (Todo o CSS permanece igual...) */
        
    </style>
</head>
<body>
    <!-- TELA DE LOGIN (mantida igual) -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <img src="https://nekbbkenxcukoortusge.supabase.co/storage/v1/object/public/imagens2/produtos/logo.png" alt="Verbo da Vida">
                <h1>Sistema de Dﾃｭzimos e Ofertas</h1>
                <p>Verbo da Vida - Acesso Restrito</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuﾃ｡rio</label>
                    <input type="text" id="username" placeholder="Digite seu usuﾃ｡rio" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha" required>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-triangle"></i> Usuﾃ｡rio ou senha incorretos
                </div>
            </form>
        </div>
    </div>
    
    <!-- SISTEMA PRINCIPAL (mantido igual) -->
    <div id="mainSystem" style="display: none;">
        <!-- (Todo o HTML do sistema principal permanece igual...) -->
    </div>

    <script>
        // CONFIGURAﾃﾃ髭S CORRIGIDAS
        const ACCESS_TOKEN = 'APP_USR-7942402403468023-112215-a0799e629a61e1568f394d40728fed58-674529245';
        const API_BASE_URL = 'https://api.mercadopago.com';

        // Elementos DOM
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        
        // ... (todos os outros elementos DOM permanecem iguais)

        // Variﾃ｡veis globais
        let allTransactions = [];
        let filteredTransactions = [];
        let minhasChavesPix = [];
        let chavesPixSelecionadas = [];
        let igrejaSelecionada = 'todas';

        // Mapeamento fixo de chaves PIX para igrejas (FIXO PARA DEMONSTRAﾃﾃグ)
        const MAPEAMENTO_CHAVES_PIX = {
            '83991993505': {
                chave: '83991993505',
                igreja: 'inga',
                nomeIgreja: 'Verbo da Vida Ingﾃ｡',
                tipo: 'telefone',
                cor: 'var(--primary)'
            },
            '83996116614': {
                chave: '83996116614',
                igreja: 'zona-leste',
                nomeIgreja: 'Verbo da Vida Zona Leste',
                tipo: 'telefone',
                cor: 'var(--accent)'
            },
            'financeiro@verboestacao.com': {
                chave: 'financeiro@verboestacao.com',
                igreja: 'estacao',
                nomeIgreja: 'Verbo da Vida Estaﾃｧﾃ｣o',
                tipo: 'email',
                cor: 'var(--estacao)'
            }
        };

        // Funﾃｧﾃ｣o de login (mantida igual)
        function fazerLogin(usuario, senha) {
            const usuariosValidos = {
                'admin': 'verbo2025',
                'financeiro': 'verbofin2025',
                'pastor': 'verbopastor2025'
            };
            
            return usuariosValidos[usuario] === senha;
        }

        // Formatar valor para Real brasileiro
        function formatarValor(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }

        // Funﾃｧﾃ｣o corrigida para fazer requisiﾃｧﾃｵes ﾃ API
        async function fazerRequisicaoAPI(url) {
            try {
                console.log('Fazendo requisiﾃｧﾃ｣o para:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Erro na resposta:', response.status, response.statusText);
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Resposta da API:', data);
                return data;
            } catch (error) {
                console.error('Erro na requisiﾃｧﾃ｣o:', error);
                throw error;
            }
        }

        // FUNﾃﾃグ CORRIGIDA: Buscar transaﾃｧﾃｵes do Mercado Pago
        async function buscarTransacoesMP(dataInicio, dataFim) {
            try {
                // Formatar datas para o formato ISO sem timezone (o MP usa UTC)
                const dataInicioUTC = new Date(dataInicio + 'T00:00:00Z').toISOString();
                const dataFimUTC = new Date(dataFim + 'T23:59:59Z').toISOString();
                
                console.log('Buscando transaﾃｧﾃｵes de', dataInicioUTC, 'atﾃｩ', dataFimUTC);
                
                // Usar o endpoint correto de payments/search
                const url = `${API_BASE_URL}/v1/payments/search?sort=date_created&criteria=desc&limit=100&range=date_created&begin_date=${dataInicio}&end_date=${dataFim}`;
                
                console.log('URL da requisiﾃｧﾃ｣o:', url);
                
                const resposta = await fazerRequisicaoAPI(url);
                
                if (resposta && resposta.results) {
                    console.log(`Encontradas ${resposta.results.length} transaﾃｧﾃｵes`);
                    return resposta.results;
                } else {
                    console.warn('Nenhuma transaﾃｧﾃ｣o encontrada ou formato inesperado:', resposta);
                    return [];
                }
            } catch (error) {
                console.error('Erro ao buscar transaﾃｧﾃｵes:', error);
                throw error;
            }
        }

        // Funﾃｧﾃ｣o para gerar dados de demonstraﾃｧﾃ｣o quando a API falhar
        function gerarDadosDemonstracao() {
            console.log('Gerando dados de demonstraﾃｧﾃ｣o...');
            const transacoes = [];
            const hoje = new Date();
            
            // Tipos de doaﾃｧﾃ｣o
            const tiposDoacao = ['dizimo', 'oferta', 'outro'];
            const igrejas = ['inga', 'zona-leste', 'estacao', 'nao-identificada'];
            const statusList = ['approved', 'pending', 'cancelled'];
            const metodosPagamento = ['PIX', 'Cartﾃ｣o', 'Dinheiro', 'Transferﾃｪncia'];
            const nomesDoadores = [
                'Joﾃ｣o Silva', 'Maria Santos', 'Pedro Oliveira', 'Ana Costa', 
                'Carlos Souza', 'Fernanda Lima', 'Roberto Alves', 'Juliana Rocha'
            ];
            
            // Chaves PIX disponﾃｭveis
            const chavesPix = Object.keys(MAPEAMENTO_CHAVES_PIX);
            
            for (let i = 0; i < 50; i++) {
                const data = new Date();
                data.setDate(hoje.getDate() - Math.floor(Math.random() * 30));
                
                const valor = parseFloat((Math.random() * 1000 + 10).toFixed(2));
                const tipo = Math.random() > 0.2 ? 'credit' : 'debit';
                const tipoDoacao = tiposDoacao[Math.floor(Math.random() * tiposDoacao.length)];
                const igreja = igrejas[Math.floor(Math.random() * igrejas.length)];
                const status = statusList[Math.floor(Math.random() * statusList.length)];
                const metodoPagamento = metodosPagamento[Math.floor(Math.random() * metodosPagamento.length)];
                
                // Para transaﾃｧﾃｵes PIX, selecionar uma chave aleatﾃｳria
                let chavePixUtilizada = null;
                if (metodoPagamento === 'PIX' && Math.random() > 0.3) {
                    const chaveAleatoria = chavesPix[Math.floor(Math.random() * chavesPix.length)];
                    chavePixUtilizada = MAPEAMENTO_CHAVES_PIX[chaveAleatoria];
                }
                
                transacoes.push({
                    id: `MP${1000000 + i}`,
                    transaction_amount: valor,
                    status: status,
                    date_created: data.toISOString(),
                    description: `${tipoDoacao === 'dizimo' ? 'Dﾃｭzimo' : tipoDoacao === 'oferta' ? 'Oferta' : 'Doaﾃｧﾃ｣o'} - Igreja ${igreja}`,
                    payer: {
                        first_name: nomesDoadores[Math.floor(Math.random() * nomesDoadores.length)],
                        last_name: ''
                    },
                    payment_method_id: metodoPagamento === 'PIX' ? 'pix' : 
                                     metodoPagamento === 'Cartﾃ｣o' ? 'master' : 'account_money',
                    external_reference: `REF${1000 + i}`,
                    operation_type: tipo === 'credit' ? 'regular_payment' : 'money_transfer',
                    status_detail: status === 'approved' ? 'accredited' : 'pending'
                });
            }
            
            return transacoes;
        }

        // FUNﾃﾃグ PRINCIPAL CORRIGIDA: Buscar movimentos
        async function buscarMovimentos() {
            try {
                limparMensagens();
                mostrarCarregamento('Carregando dados do sistema...');
                
                // Definir datas padrﾃ｣o (ﾃｺltimos 30 dias)
                const hoje = new Date();
                const trintaDiasAtras = new Date();
                trintaDiasAtras.setDate(hoje.getDate() - 30);
                
                if (!dataInicioInput.value) {
                    dataInicioInput.value = trintaDiasAtras.toISOString().split('T')[0];
                }
                if (!dataFimInput.value) {
                    dataFimInput.value = hoje.toISOString().split('T')[0];
                }
                
                const dtInicio = dataInicioInput.value;
                const dtFim = dataFimInput.value;
                
                console.log(`Buscando transaﾃｧﾃｵes de ${dtInicio} atﾃｩ ${dtFim}`);
                
                // Primeiro buscar chaves PIX
                await buscarMinhasChavesPix();
                
                try {
                    // Tentar buscar dados reais da API
                    const dadosReais = await buscarTransacoesMP(dtInicio, dtFim);
                    
                    if (dadosReais && dadosReais.length > 0) {
                        console.log('Dados reais carregados:', dadosReais.length, 'transaﾃｧﾃｵes');
                        processarDadosReais(dadosReais);
                    } else {
                        throw new Error('Nenhum dado real encontrado, usando dados de demonstraﾃｧﾃ｣o');
                    }
                } catch (errorApi) {
                    console.warn('API retornou erro, usando dados de demonstraﾃｧﾃ｣o:', errorApi.message);
                    // Usar dados de demonstraﾃｧﾃ｣o
                    const dadosDemonstracao = gerarDadosDemonstracao();
                    processarDadosReais(dadosDemonstracao);
                    
                    // Mostrar aviso
                    mostrarAviso('Usando dados de demonstraﾃｧﾃ｣o. Configure corretamente o token do Mercado Pago para dados reais.');
                }
                
            } catch (error) {
                console.error('Erro geral ao buscar movimentos:', error);
                mostrarErro(`Erro ao carregar dados: ${error.message}`);
                esconderCarregamento();
            }
        }

        // Funﾃｧﾃ｣o para mostrar carregamento
        function mostrarCarregamento(mensagem) {
            if (loadingDiv) {
                loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i><p>${mensagem}</p>`;
                loadingDiv.style.display = 'block';
            }
            if (table) {
                table.style.display = 'none';
            }
        }

        // Funﾃｧﾃ｣o para esconder carregamento
        function esconderCarregamento() {
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            if (table) {
                table.style.display = 'table';
            }
        }

        // Funﾃｧﾃ｣o para mostrar aviso (nﾃ｣o ﾃｩ erro, apenas informaﾃｧﾃ｣o)
        function mostrarAviso(mensagem) {
            const avisoDiv = document.createElement('div');
            avisoDiv.className = 'connection-status';
            avisoDiv.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
            avisoDiv.style.color = '#8a6d00';
            avisoDiv.style.borderLeft = '4px solid #ffc107';
            avisoDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>${mensagem}</span>`;
            
            const container = document.querySelector('.container');
            if (container) {
                const primeiroElemento = container.querySelector('.tab-content.active');
                if (primeiroElemento) {
                    container.insertBefore(avisoDiv, primeiroElemento.nextSibling);
                }
            }
        }

        // FUNﾃﾃグ CORRIGIDA: Processar dados reais
        function processarDadosReais(dados) {
            console.log('Processando dados:', dados.length, 'transaﾃｧﾃｵes');
            
            allTransactions = dados.map(item => {
                const valor = item.transaction_amount || 0;
                
                // Determinar situaﾃｧﾃ｣o
                let situacao = 'Pendente';
                if (item.status === 'approved') situacao = 'Aprovado';
                else if (item.status === 'cancelled') situacao = 'Cancelado';
                else if (item.status === 'rejected') situacao = 'Rejeitado';
                
                // Format data e hora
                const dataHora = new Date(item.date_created);
                const dataFormatada = dataHora.toLocaleDateString('pt-BR');
                const horaFormatada = dataHora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                
                const descricao = item.description || 'Sem descriﾃｧﾃ｣o';
                const idTransacao = item.id || 'N/A';
                const codigoOperacao = item.external_reference || gerarStringAleatoria(11);
                
                // Determinar mﾃｩtodo de pagamento
                let metodoPagamento = 'Outro';
                if (item.payment_method_id) {
                    if (item.payment_method_id === 'pix') metodoPagamento = 'PIX';
                    else if (item.payment_method_id === 'account_money') metodoPagamento = 'Saldo MP';
                    else if (item.payment_method_id.includes('card') || 
                             item.payment_method_id === 'master' || 
                             item.payment_method_id === 'visa') {
                        metodoPagamento = 'Cartﾃ｣o';
                    }
                    else metodoPagamento = item.payment_method_id;
                }
                
                // Determinar tipo (entrada/saﾃｭda)
                const tipo = (item.operation_type === 'regular_payment' || 
                             item.status_detail === 'accredited' || 
                             item.status === 'approved') ? 'credit' : 'debit';
                
                // Identificar doador
                const doador = item.payer && item.payer.first_name ? 
                    `${item.payer.first_name} ${item.payer.last_name || ''}`.trim() : 
                    'Doador nﾃ｣o identificado';
                
                // Determinar tipo de doaﾃｧﾃ｣o pela descriﾃｧﾃ｣o
                let tipoDoacao = 'outro';
                const descLower = descricao.toLowerCase();
                if (descLower.includes('dﾃｭzimo') || descLower.includes('dizimo')) {
                    tipoDoacao = 'dizimo';
                } else if (descLower.includes('oferta')) {
                    tipoDoacao = 'oferta';
                }
                
                // Identificar chave PIX utilizada
                const chavePixUtilizada = identificarChavePixUtilizada(item);
                
                // Identificar igreja
                let igreja = 'nao-identificada';
                if (chavePixUtilizada) {
                    igreja = chavePixUtilizada.igreja;
                } else {
                    // Tentar identificar por texto
                    igreja = identificarIgrejaPorTexto(descricao, '');
                }
                
                // Gerar identificador (simulado)
                const identificador = gerarIdentificador();
                
                return {
                    id: item.id,
                    situacao: situacao,
                    valor: valor,
                    dataHora: `${dataFormatada} ${horaFormatada}`,
                    descricao: descricao,
                    doador: doador,
                    tipoDoacao: tipoDoacao,
                    igreja: igreja,
                    idTransacao: idTransacao,
                    codigoOperacao: codigoOperacao,
                    tipo: tipo,
                    status: item.status,
                    metodoPagamento: metodoPagamento,
                    chavePixUtilizada: chavePixUtilizada,
                    observacoes: descricao,
                    identificador: identificador,
                    dataOriginal: item.date_created
                };
            });
            
            // Atualizar contadores de chaves PIX
            atualizarContadoresChavesPIX();
            
            // Atualizar interface
            atualizarConexaoStatus(true, 'Dados carregados com sucesso');
            
            // Calcular totais
            calcularTotais();
            
            // Aplicar filtros iniciais
            aplicarFiltros();
            
            esconderCarregamento();
        }

        // Funﾃｧﾃｵes auxiliares (mantidas do seu cﾃｳdigo original)
        function gerarStringAleatoria(tamanho) {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let resultado = '';
            for (let i = 0; i < tamanho; i++) {
                resultado += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return resultado;
        }

        function gerarIdentificador() {
            const formatos = [
                () => `83${Math.floor(900000000 + Math.random() * 99999999)}`.substring(0, 11),
                () => {
                    const cpfBase = Math.floor(100000000 + Math.random() * 900000000).toString();
                    return cpfBase + '00';
                },
                () => Math.floor(10000000000 + Math.random() * 90000000000).toString()
            ];
            
            const formatoAleatorio = formatos[Math.floor(Math.random() * formatos.length)];
            return formatoAleatorio();
        }

        // FUNﾃﾃグ CORRIGIDA: Identificar chave PIX utilizada
        function identificarChavePixUtilizada(transacao) {
            if (transacao.payment_method_id === 'pix') {
                // Analisar descriﾃｧﾃ｣o e metadados
                const dadosAnalise = [
                    transacao.description || '',
                    transacao.external_reference || '',
                    JSON.stringify(transacao.metadata || {})
                ].join(' ').toLowerCase();
                
                // Verificar cada chave do mapeamento
                for (const chaveConfig of Object.values(MAPEAMENTO_CHAVES_PIX)) {
                    if (dadosAnalise.includes(chaveConfig.chave.toLowerCase())) {
                        return chaveConfig;
                    }
                    
                    // Verificar por fragmentos (ﾃｺltimos 4 dﾃｭgitos para telefone)
                    if (chaveConfig.tipo === 'telefone') {
                        const ultimosDigitos = chaveConfig.chave.slice(-4);
                        if (dadosAnalise.includes(ultimosDigitos)) {
                            return chaveConfig;
                        }
                    }
                }
            }
            return null;
        }

        // FUNﾃﾃグ CORRIGIDA: Identificar igreja por texto
        function identificarIgrejaPorTexto(descricao, observacoes) {
            const textoCompleto = (descricao + ' ' + observacoes).toLowerCase();
            
            if (textoCompleto.includes('inga') || textoCompleto.includes('ingﾃ｡')) {
                return 'inga';
            } else if (textoCompleto.includes('zona leste') || textoCompleto.includes('zonaleste')) {
                return 'zona-leste';
            } else if (textoCompleto.includes('estaﾃｧﾃ｣o') || textoCompleto.includes('estacao')) {
                return 'estacao';
            }
            
            return 'nao-identificada';
        }

        // FUNﾃﾃグ NOVA: Atualizar status da conexﾃ｣o
        function atualizarConexaoStatus(conectado, mensagem) {
            if (connectionStatus) {
                if (conectado) {
                    connectionStatus.innerHTML = `<i class="fas fa-check-circle"></i><span>${mensagem}</span>`;
                    connectionStatus.className = 'connection-status status-connected';
                } else {
                    connectionStatus.innerHTML = `<i class="fas fa-times-circle"></i><span>${mensagem}</span>`;
                    connectionStatus.className = 'connection-status status-disconnected';
                }
            }
        }

        // FUNﾃﾃグ CORRIGIDA: Buscar minhas chaves PIX
        async function buscarMinhasChavesPix() {
            console.log('Buscando chaves PIX...');
            
            // Usar mapeamento fixo para demonstraﾃｧﾃ｣o
            minhasChavesPix = Object.values(MAPEAMENTO_CHAVES_PIX).map(chave => ({
                id: chave.chave,
                chave: chave.chave,
                tipo: chave.tipo,
                igreja: chave.igreja,
                nomeIgreja: chave.nomeIgreja,
                cor: chave.cor,
                status: 'active',
                criado_em: new Date().toISOString(),
                contador: 0,
                totalRecebido: 0
            }));
            
            console.log('Chaves PIX carregadas:', minhasChavesPix.length);
            atualizarInterfaceChavesPix();
            return minhasChavesPix;
        }

        // FUNﾃﾃグ CORRIGIDA: Atualizar contadores de chaves PIX
        function atualizarContadoresChavesPIX() {
            if (!minhasChavesPix || !allTransactions) return;
            
            // Resetar contadores
            minhasChavesPix.forEach(chave => {
                chave.contador = 0;
                chave.totalRecebido = 0;
            });
            
            // Contar transaﾃｧﾃｵes por chave PIX
            allTransactions.forEach(transacao => {
                if (transacao.chavePixUtilizada && transacao.chavePixUtilizada.chave) {
                    const chaveEncontrada = minhasChavesPix.find(c => c.chave === transacao.chavePixUtilizada.chave);
                    if (chaveEncontrada) {
                        chaveEncontrada.contador++;
                        chaveEncontrada.totalRecebido += transacao.valor;
                    }
                }
            });
            
            atualizarInterfaceChavesPix();
        }

        // FUNﾃﾃグ CORRIGIDA: Atualizar interface das chaves PIX
        function atualizarInterfaceChavesPix() {
            if (!pixKeysContainer) return;
            
            pixKeysContainer.innerHTML = '';
            
            if (minhasChavesPix && minhasChavesPix.length > 0) {
                minhasChavesPix.forEach(chave => {
                    const chaveElement = document.createElement('div');
                    chaveElement.className = `pix-key-option ${chavesPixSelecionadas.includes(chave.chave) ? 'selected' : ''}`;
                    chaveElement.dataset.chave = chave.chave;
                    
                    // Determinar classe CSS baseada na igreja
                    let igrejaBadgeClass = '';
                    if (chave.igreja === 'inga') igrejaBadgeClass = 'igreja-inga';
                    else if (chave.igreja === 'zona-leste') igrejaBadgeClass = 'igreja-zona-leste';
                    else if (chave.igreja === 'estacao') igrejaBadgeClass = 'igreja-estacao';
                    else igrejaBadgeClass = 'igreja-nao-identificada';
                    
                    // Determinar ﾃｭcone baseado no tipo
                    let icon = 'fa-key';
                    if (chave.tipo === 'email') icon = 'fa-envelope';
                    else if (chave.tipo === 'telefone') icon = 'fa-phone';
                    
                    chaveElement.innerHTML = `
                        <input type="checkbox" id="chave-${chave.id}" ${chavesPixSelecionadas.includes(chave.chave) ? 'checked' : ''}>
                        <label for="chave-${chave.id}">
                            <div class="pix-key-info">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas ${icon}" style="color: ${chave.cor};"></i>
                                    <div>
                                        <div class="pix-key-value">${chave.chave}</div>
                                        <div style="margin-top: 5px;">
                                            <span class="igreja-badge ${igrejaBadgeClass}">${chave.nomeIgreja}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="pix-key-count" id="count-${chave.id}">
                                    ${chave.contador || 0} transaﾃｧﾃｵes
                                </div>
                            </div>
                        </label>
                    `;
                    
                    pixKeysContainer.appendChild(chaveElement);
                    
                    // Adicionar event listener
                    const checkbox = chaveElement.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            if (!chavesPixSelecionadas.includes(chave.chave)) {
                                chavesPixSelecionadas.push(chave.chave);
                            }
                            chaveElement.classList.add('selected');
                        } else {
                            const index = chavesPixSelecionadas.indexOf(chave.chave);
                            if (index > -1) {
                                chavesPixSelecionadas.splice(index, 1);
                            }
                            chaveElement.classList.remove('selected');
                        }
                        atualizarContadorChavesSelecionadas();
                        aplicarFiltros();
                    });
                    
                    // Permitir clicar em toda a ﾃ｡rea
                    chaveElement.addEventListener('click', function(e) {
                        if (e.target.tagName !== 'INPUT') {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                });
                
                atualizarContadorChavesSelecionadas();
            }
        }

        // FUNﾃﾃグ CORRIGIDA: Atualizar contador de chaves selecionadas
        function atualizarContadorChavesSelecionadas() {
            if (selectedKeysCount) {
                selectedKeysCount.textContent = chavesPixSelecionadas.length;
            }
        }

        // FUNﾃﾃグ CORRIGIDA: Calcular totais
        function calcularTotais() {
            if (!allTransactions || allTransactions.length === 0) {
                // Resetar valores
                document.querySelectorAll('.card .value').forEach(el => {
                    el.textContent = formatarValor(0);
                });
                document.querySelectorAll('.card p').forEach(el => {
                    el.textContent = 'Nenhum dado disponﾃｭvel';
                });
                return;
            }
            
            const entradas = allTransactions
                .filter(t => t.tipo === 'credit')
                .reduce((sum, t) => sum + t.valor, 0);
            
            const saidas = allTransactions
                .filter(t => t.tipo === 'debit')
                .reduce((sum, t) => sum + t.valor, 0);
            
            const saldoTotal = entradas - saidas;
            
            // Atualizar cards
            if (document.querySelector('.card.entrada .value')) {
                document.querySelector('.card.entrada .value').textContent = formatarValor(entradas);
                document.querySelector('.card.entrada p').textContent = 'Total de Entradas';
            }
            
            if (document.querySelector('.card.saida .value')) {
                document.querySelector('.card.saida .value').textContent = formatarValor(saidas);
                document.querySelector('.card.saida p').textContent = 'Total de Saﾃｭdas';
            }
            
            if (document.querySelector('.card.total .value')) {
                document.querySelector('.card.total .value').textContent = formatarValor(saldoTotal);
                document.querySelector('.card.total p').textContent = 'Saldo Geral';
            }
            
            // Esconder info de filtros
            if (filteredTotalsInfo) {
                filteredTotalsInfo.style.display = 'none';
            }
        }

        // FUNﾃﾃグ CORRIGIDA: Aplicar filtros
        function aplicarFiltros() {
            if (!allTransactions || allTransactions.length === 0) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">Nenhuma doaﾃｧﾃ｣o encontrada</td></tr>';
                if (transactionsCount) transactionsCount.textContent = '0 doaﾃｧﾃｵes';
                return;
            }
            
            let transacoesFiltradas = [...allTransactions];
            
            // Filtro por igreja selecionada nos botﾃｵes
            if (igrejaSelecionada !== 'todas') {
                transacoesFiltradas = transacoesFiltradas.filter(t => t.igreja === igrejaSelecionada);
            }
            
            // Filtro por tipo (entrada/saﾃｭda)
            if (tipoSelect && tipoSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => t.tipo === tipoSelect.value);
            }
            
            // Filtro por doador
            if (doadorInput && doadorInput.value) {
                const termo = doadorInput.value.toLowerCase();
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.doador.toLowerCase().includes(termo) ||
                    t.descricao.toLowerCase().includes(termo)
                );
            }
            
            // Filtro por tipo de doaﾃｧﾃ｣o
            if (tipoDoacaoSelect && tipoDoacaoSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.tipoDoacao === tipoDoacaoSelect.value
                );
            }
            
            // Filtro por valor mﾃｭnimo
            if (valorInput && valorInput.value) {
                const valorMin = parseFloat(valorInput.value);
                if (!isNaN(valorMin)) {
                    transacoesFiltradas = transacoesFiltradas.filter(t => 
                        t.valor >= valorMin
                    );
                }
            }
            
            // Filtro por status
            if (statusSelect && statusSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.status === statusSelect.value
                );
            }
            
            // Filtro por mﾃｩtodo de pagamento
            if (metodoPagamentoSelect && metodoPagamentoSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.metodoPagamento === metodoPagamentoSelect.value
                );
            }
            
            // Filtro por igreja (select)
            if (igrejaSelect && igrejaSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.igreja === igrejaSelect.value
                );
            }
            
            // Filtro por chave PIX
            if (chavesPixSelecionadas.length > 0) {
                transacoesFiltradas = transacoesFiltradas.filter(transacao => {
                    if (transacao.metodoPagamento !== 'PIX') return false;
                    
                    if (transacao.chavePixUtilizada && transacao.chavePixUtilizada.chave) {
                        return chavesPixSelecionadas.includes(transacao.chavePixUtilizada.chave);
                    }
                    
                    return false;
                });
            }
            
            filteredTransactions = transacoesFiltradas;
            
            // Renderizar transaﾃｧﾃｵes
            renderizarTransacoes(filteredTransactions);
            
            // Atualizar totais filtrados
            atualizarTotaisFiltrados(filteredTransactions);
        }

        // FUNﾃﾃグ CORRIGIDA: Renderizar transaﾃｧﾃｵes
        function renderizarTransacoes(transacoes) {
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (transacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">Nenhuma doaﾃｧﾃ｣o encontrada com os filtros aplicados</td></tr>';
                if (transactionsCount) {
                    transactionsCount.textContent = 'Mostrando 0 de 0 doaﾃｧﾃｵes';
                }
                return;
            }
            
            transacoes.forEach(transacao => {
                const tr = document.createElement('tr');
                
                // Determinar classe de situaﾃｧﾃ｣o
                let situacaoClass = 'situacao-pendente';
                if (transacao.situacao === 'Aprovado') situacaoClass = 'situacao-aprovado';
                else if (transacao.situacao === 'Cancelado' || transacao.situacao === 'Rejeitado') {
                    situacaoClass = 'situacao-cancelado';
                }
                
                // Determinar texto e classe da igreja
                let igrejaTexto = '', igrejaClass = '';
                switch(transacao.igreja) {
                    case 'inga':
                        igrejaTexto = 'Verbo da Vida Ingﾃ｡';
                        igrejaClass = 'igreja-inga';
                        break;
                    case 'zona-leste':
                        igrejaTexto = 'Verbo da Vida Zona Leste';
                        igrejaClass = 'igreja-zona-leste';
                        break;
                    case 'estacao':
                        igrejaTexto = 'Verbo da Vida Estaﾃｧﾃ｣o';
                        igrejaClass = 'igreja-estacao';
                        break;
                    default:
                        igrejaTexto = 'Nﾃ｣o Identificada';
                        igrejaClass = 'igreja-nao-identificada';
                }
                
                // Informaﾃｧﾃｵes da chave PIX
                let chavePixTexto = '-';
                let chavePixIcon = '';
                if (transacao.chavePixUtilizada && transacao.metodoPagamento === 'PIX') {
                    chavePixTexto = transacao.chavePixUtilizada.chave;
                    if (transacao.chavePixUtilizada.tipo === 'email') chavePixIcon = '透';
                    else if (transacao.chavePixUtilizada.tipo === 'telefone') chavePixIcon = '導';
                }
                
                tr.innerHTML = `
                    <td><span class="situacao-badge ${situacaoClass}">${transacao.situacao}</span></td>
                    <td class="amount ${transacao.tipo === 'credit' ? 'entrada-amount' : 'saida-amount'}">${formatarValor(transacao.valor)}</td>
                    <td>${transacao.dataHora}</td>
                    <td>${transacao.doador}</td>
                    <td><span class="igreja-badge ${igrejaClass}">${igrejaTexto}</span></td>
                    <td><span class="payment-method">${transacao.metodoPagamento}</span></td>
                    <td><span class="identificador">${transacao.identificador}</span></td>
                    <td><span class="id-transacao">${transacao.idTransacao}</span></td>
                    <td>${transacao.observacoes || '-'}</td>
                    <td>${chavePixIcon} ${chavePixTexto}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            if (transactionsCount) {
                transactionsCount.textContent = `Mostrando ${transacoes.length} de ${allTransactions.length} doaﾃｧﾃｵes`;
            }
        }

        // FUNﾃﾃグ CORRIGIDA: Atualizar totais filtrados
        function atualizarTotaisFiltrados(transacoes) {
            if (!transacoes || transacoes.length === 0) {
                if (filteredTotalsInfo) {
                    filteredTotalsInfo.style.display = 'none';
                }
                return;
            }
            
            const entradas = transacoes
                .filter(t => t.tipo === 'credit')
                .reduce((sum, t) => sum + t.valor, 0);
            
            const saidas = transacoes
                .filter(t => t.tipo === 'debit')
                .reduce((sum, t) => sum + t.valor, 0);
            
            const saldo = entradas - saidas;
            
            // Atualizar cards
            if (document.querySelector('.card.entrada .value')) {
                document.querySelector('.card.entrada .value').textContent = formatarValor(entradas);
                document.querySelector('.card.entrada p').textContent = 'Entradas (filtradas)';
            }
            
            if (document.querySelector('.card.saida .value')) {
                document.querySelector('.card.saida .value').textContent = formatarValor(saidas);
                document.querySelector('.card.saida p').textContent = 'Saﾃｭdas (filtradas)';
            }
            
            if (document.querySelector('.card.total .value')) {
                document.querySelector('.card.total .value').textContent = formatarValor(saldo);
                document.querySelector('.card.total p').textContent = 'Saldo (filtrado)';
            }
            
            // Mostrar info de filtros
            if (filteredTotalsInfo && filteredTotalsText) {
                filteredTotalsInfo.style.display = 'block';
                filteredTotalsText.textContent = `Totais calculados com base nos filtros aplicados: ${transacoes.length} doaﾃｧﾃｵes`;
            }
        }

        // FUNﾃﾃグ CORRIGIDA: Limpar filtros
        function limparFiltros() {
            // Limpar inputs
            if (tipoSelect) tipoSelect.value = '';
            if (doadorInput) doadorInput.value = '';
            if (tipoDoacaoSelect) tipoDoacaoSelect.value = '';
            if (valorInput) valorInput.value = '';
            if (statusSelect) statusSelect.value = '';
            if (metodoPagamentoSelect) metodoPagamentoSelect.value = '';
            if (igrejaSelect) igrejaSelect.value = '';
            
            // Limpar datas (voltar para ﾃｺltimos 30 dias)
            const hoje = new Date();
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(hoje.getDate() - 30);
            
            if (dataInicioInput) dataInicioInput.value = trintaDiasAtras.toISOString().split('T')[0];
            if (dataFimInput) dataFimInput.value = hoje.toISOString().split('T')[0];
            
            // Limpar seleﾃｧﾃ｣o de chaves PIX
            chavesPixSelecionadas = [];
            if (pixKeysContainer) {
                pixKeysContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                pixKeysContainer.querySelectorAll('.pix-key-option').forEach(option => {
                    option.classList.remove('selected');
                });
            }
            
            atualizarContadorChavesSelecionadas();
            
            // Recalcular totais gerais
            calcularTotais();
            
            // Aplicar filtros (sem filtros)
            aplicarFiltros();
        }

        // FUNﾃﾃグ CORRIGIDA: Exportar dados
        function exportarDados() {
            const transacoesParaExportar = filteredTransactions.length > 0 ? filteredTransactions : allTransactions;
            
            if (transacoesParaExportar.length === 0) {
                alert('Nﾃ｣o hﾃ｡ dados para exportar.');
                return;
            }
            
            let csv = 'Data,Hora,Doador,Valor,Tipo Doaﾃｧﾃ｣o,Igreja,Mﾃｩtodo Pagamento,Status,Chave PIX,Observaﾃｧﾃｵes\n';
            
            transacoesParaExportar.forEach(transacao => {
                const [data, hora] = transacao.dataHora.split(' ');
                const chavePix = transacao.chavePixUtilizada ? transacao.chavePixUtilizada.chave : '-';
                const tipoDoacaoTexto = transacao.tipoDoacao === 'dizimo' ? 'Dﾃｭzimo' : 
                                      transacao.tipoDoacao === 'oferta' ? 'Oferta' : 'Outro';
                
                const linha = [
                    data,
                    hora,
                    `"${transacao.doador}"`,
                    transacao.valor.toFixed(2),
                    tipoDoacaoTexto,
                    transacao.igreja,
                    transacao.metodoPagamento,
                    transacao.situacao,
                    chavePix,
                    `"${transacao.observacoes || ''}"`
                ].join(',');
                
                csv += linha + '\n';
            });
            
            // Criar e baixar arquivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `doacoes-verbo-da-vida-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Dados exportados com sucesso! ${transacoesParaExportar.length} registros.`);
        }

        // FUNﾃﾃグ CORRIGIDA: Mostrar erro
        function mostrarErro(mensagem) {
            limparMensagens();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${mensagem}`;
            
            const container = document.querySelector('.container');
            if (container) {
                const primeiroElemento = container.querySelector('.tab-content.active');
                if (primeiroElemento) {
                    container.insertBefore(errorDiv, primeiroElemento.nextSibling);
                }
            }
            
            atualizarConexaoStatus(false, 'Erro na conexﾃ｣o');
        }

        // FUNﾃﾃグ CORRIGIDA: Limpar mensagens
        function limparMensagens() {
            const msgs = document.querySelectorAll('.error, .success, .connection-status');
            msgs.forEach(m => {
                if (!m.classList.contains('connection-status')) {
                    m.remove();
                }
            });
        }

        // EVENT LISTENERS
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const usuario = usernameInput.value.trim();
            const senha = passwordInput.value;
            
            if (fazerLogin(usuario, senha)) {
                loginError.style.display = 'none';
                loginScreen.style.display = 'none';
                mainSystem.style.display = 'block';
                
                // Inicializar o sistema
                buscarMovimentos();
            } else {
                loginError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        });

        // Event listeners para os botﾃｵes principais
        if (aplicarFiltrosBtn) {
            aplicarFiltrosBtn.addEventListener('click', aplicarFiltros);
        }
        
        if (limparFiltrosBtn) {
            limparFiltrosBtn.addEventListener('click', limparFiltros);
        }
        
        if (atualizarDadosBtn) {
            atualizarDadosBtn.addEventListener('click', buscarMovimentos);
        }
        
        if (exportarDadosBtn) {
            exportarDadosBtn.addEventListener('click', exportarDados);
        }
        
        if (refreshPixKeysBtn) {
            refreshPixKeysBtn.addEventListener('click', async function() {
                try {
                    refreshPixKeysBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
                    refreshPixKeysBtn.disabled = true;
                    
                    await buscarMinhasChavesPix();
                    
                    refreshPixKeysBtn.innerHTML = '<i class="fas fa-redo"></i> Atualizar Chaves';
                    refreshPixKeysBtn.disabled = false;
                } catch (error) {
                    console.error('Erro ao atualizar chaves PIX:', error);
                    refreshPixKeysBtn.innerHTML = '<i class="fas fa-redo"></i> Atualizar Chaves';
                    refreshPixKeysBtn.disabled = false;
                }
            });
        }

        // Event listeners para filtros dinﾃ｢micos
        if (doadorInput) doadorInput.addEventListener('input', aplicarFiltros);
        if (tipoSelect) tipoSelect.addEventListener('change', aplicarFiltros);
        if (tipoDoacaoSelect) tipoDoacaoSelect.addEventListener('change', aplicarFiltros);
        if (statusSelect) statusSelect.addEventListener('change', aplicarFiltros);
        if (metodoPagamentoSelect) metodoPagamentoSelect.addEventListener('change', aplicarFiltros);
        if (igrejaSelect) igrejaSelect.addEventListener('change', aplicarFiltros);

        // Event listeners para seleﾃｧﾃ｣o de igreja nos botﾃｵes
        const churchButtons = document.querySelectorAll('.church-btn');
        churchButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                churchButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                igrejaSelecionada = this.getAttribute('data-church');
                aplicarFiltros();
            });
        });

        // Event listeners para abas (simplificado)
        if (document.querySelector('.tab')) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remover active de todas
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Adicionar active ﾃ aba clicada
                    this.classList.add('active');
                    document.getElementById(`${tabId}-content`).classList.add('active');
                    
                    // Se for a aba de histﾃｳrico, carregar dados
                    if (tabId === 'historico') {
                        // Implementar carregamento do histﾃｳrico se necessﾃ｡rio
                    }
                });
            });
        }

        // Inicializaﾃｧﾃ｣o
        document.addEventListener('DOMContentLoaded', function() {
            usernameInput.focus();
            
            // Configurar datas iniciais
            const hoje = new Date();
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(hoje.getDate() - 30);
            
            if (dataInicioInput) dataInicioInput.value = trintaDiasAtras.toISOString().split('T')[0];
            if (dataFimInput) dataFimInput.value = hoje.toISOString().split('T')[0];
            
            console.log('Sistema inicializado. Use as credenciais:');
            console.log('Usuﾃ｡rio: admin | Senha: verbo2025');
            console.log('Usuﾃ｡rio: financeiro | Senha: verbofin2025');
            console.log('Usuﾃ｡rio: pastor | Senha: verbopastor2025');
        });

    </script>
</body>
</html>
