<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de D√≠zimos e Ofertas - Verbo da Vida</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* (Todo o CSS permanece exatamente igual ao seu c√≥digo original) */
        :root { 
            --primary: #1a4b8c; 
            --primary-light: #2a6fd6; 
            --secondary: #f9c80e; 
            --success: #28a745; 
            --danger: #dc3545; 
            --light: #f8f9fa; 
            --dark: #343a40; 
            --gray: #6c757d; 
            --border: #dee2e6; 
            --accent: #17a2b8;
            --estacao: #9b59b6;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8f9fa; color: var(--dark); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* ... (todo o CSS permanece exatamente igual) ... */
        
    </style>
</head>
<body>
    <!-- TELA DE LOGIN (mantida igual) -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <img src="https://nekbbkenxcukoortusge.supabase.co/storage/v1/object/public/imagens2/produtos/logo.png" alt="Verbo da Vida">
                <h1>Sistema de D√≠zimos e Ofertas</h1>
                <p>Verbo da Vida - Acesso Restrito</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usu√°rio</label>
                    <input type="text" id="username" placeholder="Digite seu usu√°rio" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha" required>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-triangle"></i> Usu√°rio ou senha incorretos
                </div>
            </form>
            
            <div style="margin-top: 20px; font-size: 0.8rem; color: var(--gray);">
                <p>Use: admin / verbo2025</p>
            </div>
        </div>
    </div>
    
    <!-- SISTEMA PRINCIPAL (mantido igual) -->
    <div id="mainSystem" style="display: none;">
        <!-- (Todo o HTML do sistema principal permanece igual) -->
    </div>

    <script>
        // CONFIGURA√á√ïES - TOKEN CORRETO DO MERCADO PAGO
        const ACCESS_TOKEN = 'APP_USR-7942402403468023-112215-a0799e629a61e1568f394d40728fed58-674529245';
        const API_BASE_URL = 'https://api.mercadopago.com';

        // Elementos DOM (mantidos iguais)
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        
        // ... (todos os outros elementos DOM permanecem iguais) ...

        // Mapeamento fixo de chaves PIX para igrejas
        const MAPEAMENTO_CHAVES_PIX = {
            '83991993505': {
                chave: '83991993505',
                igreja: 'inga',
                nomeIgreja: 'Verbo da Vida Ing√°',
                tipo: 'telefone',
                cor: '#1a4b8c'
            },
            '83996116614': {
                chave: '83996116614',
                igreja: 'zona-leste',
                nomeIgreja: 'Verbo da Vida Zona Leste',
                tipo: 'telefone',
                cor: '#17a2b8'
            },
            'financeiro@verboestacao.com': {
                chave: 'financeiro@verboestacao.com',
                igreja: 'estacao',
                nomeIgreja: 'Verbo da Vida Esta√ß√£o',
                tipo: 'email',
                cor: '#9b59b6'
            }
        };

        // Vari√°veis globais
        let allTransactions = [];
        let filteredTransactions = [];
        let minhasChavesPix = [];
        let chavesPixSelecionadas = [];
        let igrejaSelecionada = 'todas';

        // Fun√ß√£o de login (mantida igual)
        function fazerLogin(usuario, senha) {
            const usuariosValidos = {
                'admin': 'verbo2025',
                'financeiro': 'verbofin2025',
                'pastor': 'verbopastor2025'
            };
            
            return usuariosValidos[usuario] === senha;
        }

        // Formatar valor para Real brasileiro
        function formatarValor(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }

        // Fun√ß√µes auxiliares (mantidas)
        function gerarStringAleatoria(tamanho) {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let resultado = '';
            for (let i = 0; i < tamanho; i++) {
                resultado += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return resultado;
        }

        function gerarIdentificador() {
            const formatos = [
                () => `83${Math.floor(900000000 + Math.random() * 99999999)}`.substring(0, 11),
                () => {
                    const cpfBase = Math.floor(100000000 + Math.random() * 900000000).toString();
                    return cpfBase + '00';
                },
                () => Math.floor(10000000000 + Math.random() * 90000000000).toString()
            ];
            
            const formatoAleatorio = formatos[Math.floor(Math.random() * formatos.length)];
            return formatoAleatorio();
        }

        // FUN√á√ÉO CORRIGIDA: Testar conex√£o com a API do Mercado Pago
        async function testarConexaoAPI() {
            try {
                console.log('üîç Testando conex√£o com a API do Mercado Pago...');
                
                // Testar com uma requisi√ß√£o simples
                const url = `${API_BASE_URL}/v1/payments?sort=date_created&criteria=desc&limit=1`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Erro na conex√£o:', response.status, errorText);
                    
                    if (response.status === 401) {
                        throw new Error('Token de acesso inv√°lido ou expirado');
                    } else if (response.status === 403) {
                        throw new Error('Permiss√£o negada. Verifique as credenciais');
                    } else {
                        throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
                    }
                }

                const data = await response.json();
                console.log('‚úÖ Conex√£o com API estabelecida com sucesso!');
                return true;
                
            } catch (error) {
                console.error('‚ùå Falha na conex√£o com a API:', error);
                throw error;
            }
        }

        // FUN√á√ÉO CORRIGIDA: Buscar pagamentos do Mercado Pago
        async function buscarPagamentosMP(dataInicio, dataFim) {
            try {
                console.log(`üìÖ Buscando pagamentos de ${dataInicio} at√© ${dataFim}`);
                
                // Primeiro testar a conex√£o
                await testarConexaoAPI();
                
                // Formatar datas para o formato esperado pela API
                // A API do Mercado Pago espera datas no formato ISO sem timezone
                const dataInicioISO = new Date(dataInicio + 'T00:00:00').toISOString();
                const dataFimISO = new Date(dataFim + 'T23:59:59').toISOString();
                
                console.log('Datas formatadas para API:', { dataInicioISO, dataFimISO });
                
                // URL CORRETA para buscar pagamentos com filtro de data
                // Usando o par√¢metro "range" que √© suportado pela API
                const url = `${API_BASE_URL}/v1/payments/search?sort=date_created&criteria=desc&limit=100&range=date_created&begin_date=${dataInicioISO}&end_date=${dataFimISO}`;
                
                console.log('üîó URL da requisi√ß√£o:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erro na resposta:', response.status, errorText);
                    throw new Error(`Erro ao buscar pagamentos: ${response.status}`);
                }

                const data = await response.json();
                
                if (data && data.results) {
                    console.log(`‚úÖ ${data.results.length} pagamentos encontrados`);
                    return data.results;
                } else {
                    console.warn('Nenhum pagamento encontrado');
                    return [];
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar pagamentos:', error);
                throw error;
            }
        }

        // FUN√á√ÉO PRINCIPAL CORRIGIDA: Buscar movimentos
        async function buscarMovimentos() {
            try {
                mostrarCarregamento('Conectando √† API do Mercado Pago...');
                atualizarStatusConexao('Conectando...', false);
                
                // Definir datas padr√£o (√∫ltimos 30 dias)
                const hoje = new Date();
                const trintaDiasAtras = new Date();
                trintaDiasAtras.setDate(hoje.getDate() - 30);
                
                if (!dataInicioInput.value) {
                    dataInicioInput.value = trintaDiasAtras.toISOString().split('T')[0];
                }
                if (!dataFimInput.value) {
                    dataFimInput.value = hoje.toISOString().split('T')[0];
                }
                
                const dtInicio = dataInicioInput.value;
                const dtFim = dataFimInput.value;
                
                console.log(`üìä Buscando dados de ${dtInicio} at√© ${dtFim}`);
                
                // Primeiro buscar chaves PIX
                await buscarMinhasChavesPix();
                
                // Buscar DADOS REAIS da API
                console.log('üîÑ Buscando dados reais do Mercado Pago...');
                const dadosReais = await buscarPagamentosMP(dtInicio, dtFim);
                
                if (!dadosReais || dadosReais.length === 0) {
                    atualizarStatusConexao('Conectado - Nenhuma transa√ß√£o encontrada', true);
                    mostrarAviso('Nenhuma transa√ß√£o encontrada no per√≠odo selecionado');
                    processarDadosReais([]);
                } else {
                    atualizarStatusConexao(`Conectado - ${dadosReais.length} transa√ß√µes carregadas`, true);
                    processarDadosReais(dadosReais);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar movimentos:', error);
                
                // Mensagens de erro mais espec√≠ficas
                let mensagemErro = 'Erro ao conectar com a API';
                
                if (error.message.includes('Token') || error.message.includes('401')) {
                    mensagemErro = 'Token de acesso inv√°lido ou expirado';
                } else if (error.message.includes('403')) {
                    mensagemErro = 'Permiss√£o negada. Verifique as credenciais';
                } else if (error.message.includes('Failed to fetch')) {
                    mensagemErro = 'Erro de rede. Verifique sua conex√£o com a internet';
                } else {
                    mensagemErro = error.message;
                }
                
                mostrarErro(`Erro: ${mensagemErro}`);
                atualizarStatusConexao('Erro na conex√£o', false);
                esconderCarregamento();
            }
        }

        // Fun√ß√µes de interface (mantidas)
        function mostrarCarregamento(mensagem) {
            if (loadingDiv) {
                loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i><p>${mensagem}</p>`;
                loadingDiv.style.display = 'block';
            }
            if (table) {
                table.style.display = 'none';
            }
        }

        function esconderCarregamento() {
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            if (table) {
                table.style.display = 'table';
            }
        }

        function atualizarStatusConexao(mensagem, conectado) {
            if (connectionStatus) {
                if (conectado) {
                    connectionStatus.innerHTML = `<i class="fas fa-check-circle"></i><span>${mensagem}</span>`;
                    connectionStatus.className = 'connection-status status-connected';
                } else {
                    connectionStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span>${mensagem}</span>`;
                    connectionStatus.className = 'connection-status';
                }
            }
        }

        function mostrarErro(mensagem) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${mensagem}`;
            
            const container = document.querySelector('.container');
            if (container) {
                const primeiroElemento = container.querySelector('.tab-content.active');
                if (primeiroElemento) {
                    container.insertBefore(errorDiv, primeiroElemento.nextSibling);
                }
            }
        }

        function mostrarAviso(mensagem) {
            const avisoDiv = document.createElement('div');
            avisoDiv.className = 'connection-status';
            avisoDiv.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
            avisoDiv.style.color = '#8a6d00';
            avisoDiv.style.borderLeft = '4px solid #ffc107';
            avisoDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>${mensagem}</span>`;
            
            const container = document.querySelector('.container');
            if (container) {
                const primeiroElemento = container.querySelector('.tab-content.active');
                if (primeiroElemento) {
                    container.insertBefore(avisoDiv, primeiroElemento.nextSibling);
                }
            }
        }

        // Processar dados reais
        function processarDadosReais(dados) {
            console.log('üîÑ Processando dados:', dados.length, 'transa√ß√µes');
            
            allTransactions = dados.map(item => {
                const valor = item.transaction_amount || 0;
                
                // Determinar situa√ß√£o
                let situacao = 'Pendente';
                if (item.status === 'approved') situacao = 'Aprovado';
                else if (item.status === 'cancelled') situacao = 'Cancelado';
                else if (item.status === 'rejected') situacao = 'Rejeitado';
                
                // Formatar data e hora
                const dataHora = new Date(item.date_created);
                const dataFormatada = dataHora.toLocaleDateString('pt-BR');
                const horaFormatada = dataHora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                
                const descricao = item.description || 'Sem descri√ß√£o';
                const idTransacao = item.id || 'N/A';
                const codigoOperacao = item.external_reference || gerarStringAleatoria(11);
                
                // Determinar m√©todo de pagamento
                let metodoPagamento = 'Outro';
                if (item.payment_method_id) {
                    if (item.payment_method_id === 'pix') metodoPagamento = 'PIX';
                    else if (item.payment_method_id === 'account_money') metodoPagamento = 'Saldo MP';
                    else if (item.payment_method_id.includes('card') || 
                             item.payment_method_id === 'master' || 
                             item.payment_method_id === 'visa') {
                        metodoPagamento = 'Cart√£o';
                    }
                    else metodoPagamento = item.payment_method_id;
                }
                
                // Determinar tipo (entrada/sa√≠da)
                const tipo = (item.operation_type === 'regular_payment' || 
                             item.status_detail === 'accredited' || 
                             item.status === 'approved') ? 'credit' : 'debit';
                
                // Identificar doador
                const doador = item.payer && item.payer.first_name ? 
                    `${item.payer.first_name} ${item.payer.last_name || ''}`.trim() : 
                    'Doador n√£o identificado';
                
                // Determinar tipo de doa√ß√£o pela descri√ß√£o
                let tipoDoacao = 'outro';
                const descLower = descricao.toLowerCase();
                if (descLower.includes('d√≠zimo') || descLower.includes('dizimo')) {
                    tipoDoacao = 'dizimo';
                } else if (descLower.includes('oferta')) {
                    tipoDoacao = 'oferta';
                }
                
                // Identificar chave PIX utilizada
                const chavePixUtilizada = identificarChavePixUtilizada(item);
                
                // Identificar igreja
                let igreja = 'nao-identificada';
                if (chavePixUtilizada) {
                    igreja = chavePixUtilizada.igreja;
                } else {
                    // Tentar identificar por texto
                    igreja = identificarIgrejaPorTexto(descricao, '');
                }
                
                // Gerar identificador (simulado)
                const identificador = gerarIdentificador();
                
                return {
                    id: item.id,
                    situacao: situacao,
                    valor: valor,
                    dataHora: `${dataFormatada} ${horaFormatada}`,
                    descricao: descricao,
                    doador: doador,
                    tipoDoacao: tipoDoacao,
                    igreja: igreja,
                    idTransacao: idTransacao,
                    codigoOperacao: codigoOperacao,
                    tipo: tipo,
                    status: item.status,
                    metodoPagamento: metodoPagamento,
                    chavePixUtilizada: chavePixUtilizada,
                    observacoes: descricao,
                    identificador: identificador,
                    dataOriginal: item.date_created
                };
            });
            
            // Atualizar contadores de chaves PIX
            atualizarContadoresChavesPIX();
            
            // Calcular totais
            calcularTotais();
            
            // Aplicar filtros iniciais
            aplicarFiltros();
            
            esconderCarregamento();
        }

        // Identificar chave PIX utilizada
        function identificarChavePixUtilizada(transacao) {
            if (transacao.payment_method_id === 'pix') {
                // Analisar descri√ß√£o e metadados
                const dadosAnalise = [
                    transacao.description || '',
                    transacao.external_reference || '',
                    JSON.stringify(transacao.metadata || {})
                ].join(' ').toLowerCase();
                
                // Verificar cada chave do mapeamento
                for (const chaveConfig of Object.values(MAPEAMENTO_CHAVES_PIX)) {
                    if (dadosAnalise.includes(chaveConfig.chave.toLowerCase())) {
                        return chaveConfig;
                    }
                    
                    // Verificar por fragmentos (√∫ltimos 4 d√≠gitos para telefone)
                    if (chaveConfig.tipo === 'telefone') {
                        const ultimosDigitos = chaveConfig.chave.slice(-4);
                        if (dadosAnalise.includes(ultimosDigitos)) {
                            return chaveConfig;
                        }
                    }
                }
            }
            return null;
        }

        // Identificar igreja por texto
        function identificarIgrejaPorTexto(descricao, observacoes) {
            const textoCompleto = (descricao + ' ' + observacoes).toLowerCase();
            
            if (textoCompleto.includes('inga') || textoCompleto.includes('ing√°')) {
                return 'inga';
            } else if (textoCompleto.includes('zona leste') || textoCompleto.includes('zonaleste')) {
                return 'zona-leste';
            } else if (textoCompleto.includes('esta√ß√£o') || textoCompleto.includes('estacao')) {
                return 'estacao';
            }
            
            return 'nao-identificada';
        }

        // Buscar minhas chaves PIX
        async function buscarMinhasChavesPix() {
            console.log('üîë Buscando chaves PIX...');
            
            // Usar mapeamento fixo
            minhasChavesPix = Object.values(MAPEAMENTO_CHAVES_PIX).map(chave => ({
                id: chave.chave,
                chave: chave.chave,
                tipo: chave.tipo,
                igreja: chave.igreja,
                nomeIgreja: chave.nomeIgreja,
                cor: chave.cor,
                status: 'active',
                criado_em: new Date().toISOString(),
                contador: 0,
                totalRecebido: 0
            }));
            
            console.log('‚úÖ Chaves PIX carregadas:', minhasChavesPix.length);
            atualizarInterfaceChavesPix();
            return minhasChavesPix;
        }

        // Atualizar contadores de chaves PIX
        function atualizarContadoresChavesPIX() {
            if (!minhasChavesPix || !allTransactions) return;
            
            // Resetar contadores
            minhasChavesPix.forEach(chave => {
                chave.contador = 0;
                chave.totalRecebido = 0;
            });
            
            // Contar transa√ß√µes por chave PIX
            allTransactions.forEach(transacao => {
                if (transacao.chavePixUtilizada && transacao.chavePixUtilizada.chave) {
                    const chaveEncontrada = minhasChavesPix.find(c => c.chave === transacao.chavePixUtilizada.chave);
                    if (chaveEncontrada) {
                        chaveEncontrada.contador++;
                        chaveEncontrada.totalRecebido += transacao.valor;
                    }
                }
            });
            
            atualizarInterfaceChavesPix();
        }

        // Atualizar interface das chaves PIX
        function atualizarInterfaceChavesPix() {
            if (!pixKeysContainer) return;
            
            pixKeysContainer.innerHTML = '';
            
            if (minhasChavesPix && minhasChavesPix.length > 0) {
                minhasChavesPix.forEach(chave => {
                    const chaveElement = document.createElement('div');
                    chaveElement.className = `pix-key-option ${chavesPixSelecionadas.includes(chave.chave) ? 'selected' : ''}`;
                    chaveElement.dataset.chave = chave.chave;
                    
                    // Determinar classe CSS baseada na igreja
                    let igrejaBadgeClass = '';
                    if (chave.igreja === 'inga') igrejaBadgeClass = 'igreja-inga';
                    else if (chave.igreja === 'zona-leste') igrejaBadgeClass = 'igreja-zona-leste';
                    else if (chave.igreja === 'estacao') igrejaBadgeClass = 'igreja-estacao';
                    else igrejaBadgeClass = 'igreja-nao-identificada';
                    
                    // Determinar √≠cone baseado no tipo
                    let icon = 'fa-key';
                    if (chave.tipo === 'email') icon = 'fa-envelope';
                    else if (chave.tipo === 'telefone') icon = 'fa-phone';
                    
                    chaveElement.innerHTML = `
                        <input type="checkbox" id="chave-${chave.id}" ${chavesPixSelecionadas.includes(chave.chave) ? 'checked' : ''}>
                        <label for="chave-${chave.id}">
                            <div class="pix-key-info">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas ${icon}" style="color: ${chave.cor};"></i>
                                    <div>
                                        <div class="pix-key-value">${chave.chave}</div>
                                        <div style="margin-top: 5px;">
                                            <span class="igreja-badge ${igrejaBadgeClass}">${chave.nomeIgreja}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="pix-key-count" id="count-${chave.id}">
                                    ${chave.contador || 0} transa√ß√µes
                                </div>
                            </div>
                        </label>
                    `;
                    
                    pixKeysContainer.appendChild(chaveElement);
                    
                    // Adicionar event listener
                    const checkbox = chaveElement.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            if (!chavesPixSelecionadas.includes(chave.chave)) {
                                chavesPixSelecionadas.push(chave.chave);
                            }
                            chaveElement.classList.add('selected');
                        } else {
                            const index = chavesPixSelecionadas.indexOf(chave.chave);
                            if (index > -1) {
                                chavesPixSelecionadas.splice(index, 1);
                            }
                            chaveElement.classList.remove('selected');
                        }
                        atualizarContadorChavesSelecionadas();
                        aplicarFiltros();
                    });
                    
                    // Permitir clicar em toda a √°rea
                    chaveElement.addEventListener('click', function(e) {
                        if (e.target.tagName !== 'INPUT') {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                });
                
                atualizarContadorChavesSelecionadas();
            }
        }

        // Atualizar contador de chaves selecionadas
        function atualizarContadorChavesSelecionadas() {
            if (selectedKeysCount) {
                selectedKeysCount.textContent = chavesPixSelecionadas.length;
            }
        }

        // Calcular totais
        function calcularTotais() {
            if (!allTransactions || allTransactions.length === 0) {
                // Resetar valores
                document.querySelectorAll('.card .value').forEach(el => {
                    el.textContent = formatarValor(0);
                });
                document.querySelectorAll('.card p').forEach(el => {
                    el.textContent = 'Nenhum dado dispon√≠vel';
                });
                return;
            }
            
            const entradas = allTransactions
                .filter(t => t.tipo === 'credit')
                .reduce((sum, t) => sum + t.valor, 0);
            
            const saidas = allTransactions
                .filter(t => t.tipo === 'debit')
                .reduce((sum, t) => sum + t.valor, 0);
            
            const saldoTotal = entradas - saidas;
            
            // Atualizar cards
            if (document.querySelector('.card.entrada .value')) {
                document.querySelector('.card.entrada .value').textContent = formatarValor(entradas);
                document.querySelector('.card.entrada p').textContent = 'Total de Entradas';
            }
            
            if (document.querySelector('.card.saida .value')) {
                document.querySelector('.card.saida .value').textContent = formatarValor(saidas);
                document.querySelector('.card.saida p').textContent = 'Total de Sa√≠das';
            }
            
            if (document.querySelector('.card.total .value')) {
                document.querySelector('.card.total .value').textContent = formatarValor(saldoTotal);
                document.querySelector('.card.total p').textContent = 'Saldo Geral';
            }
            
            // Esconder info de filtros
            if (filteredTotalsInfo) {
                filteredTotalsInfo.style.display = 'none';
            }
        }

        // Aplicar filtros
        function aplicarFiltros() {
            if (!allTransactions || allTransactions.length === 0) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">Nenhuma doa√ß√£o encontrada</td></tr>';
                if (transactionsCount) transactionsCount.textContent = '0 doa√ß√µes';
                return;
            }
            
            let transacoesFiltradas = [...allTransactions];
            
            // Filtro por igreja selecionada nos bot√µes
            if (igrejaSelecionada !== 'todas') {
                transacoesFiltradas = transacoesFiltradas.filter(t => t.igreja === igrejaSelecionada);
            }
            
            // Filtro por tipo (entrada/sa√≠da)
            if (tipoSelect && tipoSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => t.tipo === tipoSelect.value);
            }
            
            // Filtro por doador
            if (doadorInput && doadorInput.value) {
                const termo = doadorInput.value.toLowerCase();
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.doador.toLowerCase().includes(termo) ||
                    t.descricao.toLowerCase().includes(termo)
                );
            }
            
            // Filtro por tipo de doa√ß√£o
            if (tipoDoacaoSelect && tipoDoacaoSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.tipoDoacao === tipoDoacaoSelect.value
                );
            }
            
            // Filtro por valor m√≠nimo
            if (valorInput && valorInput.value) {
                const valorMin = parseFloat(valorInput.value);
                if (!isNaN(valorMin)) {
                    transacoesFiltradas = transacoesFiltradas.filter(t => 
                        t.valor >= valorMin
                    );
                }
            }
            
            // Filtro por status
            if (statusSelect && statusSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.status === statusSelect.value
                );
            }
            
            // Filtro por m√©todo de pagamento
            if (metodoPagamentoSelect && metodoPagamentoSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.metodoPagamento === metodoPagamentoSelect.value
                );
            }
            
            // Filtro por igreja (select)
            if (igrejaSelect && igrejaSelect.value) {
                transacoesFiltradas = transacoesFiltradas.filter(t => 
                    t.igreja === igrejaSelect.value
                );
            }
            
            // Filtro por chave PIX
            if (chavesPixSelecionadas.length > 0) {
                transacoesFiltradas = transacoesFiltradas.filter(transacao => {
                    if (transacao.metodoPagamento !== 'PIX') return false;
                    
                    if (transacao.chavePixUtilizada && transacao.chavePixUtilizada.chave) {
                        return chavesPixSelecionadas.includes(transacao.chavePixUtilizada.chave);
                    }
                    
                    return false;
                });
            }
            
            filteredTransactions = transacoesFiltradas;
            
            // Renderizar transa√ß√µes
            renderizarTransacoes(filteredTransactions);
            
            // Atualizar totais filtrados
            atualizarTotaisFiltrados(filteredTransactions);
        }

        // Renderizar transa√ß√µes
        function renderizarTransacoes(transacoes) {
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (transacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">Nenhuma doa√ß√£o encontrada com os filtros aplicados</td></tr>';
                if (transactionsCount) {
                    transactionsCount.textContent = 'Mostrando 0 de 0 doa√ß√µes';
                }
                return;
            }
            
            transacoes.forEach(transacao => {
                const tr = document.createElement('tr');
                
                // Determinar classe de situa√ß√£o
                let situacaoClass = 'situacao-pendente';
                if (transacao.situacao === 'Aprovado') situacaoClass = 'situacao-aprovado';
                else if (transacao.situacao === 'Cancelado' || transacao.situacao === 'Rejeitado') {
                    situacaoClass = 'situacao-cancelado';
                }
                
                // Determinar texto e classe da igreja
                let igrejaTexto = '', igrejaClass = '';
                switch(transacao.igreja) {
                    case 'inga':
                        igrejaTexto = 'Verbo da Vida Ing√°';
                        igrejaClass = 'igreja-inga';
                        break;
                    case 'zona-leste':
                        igrejaTexto = 'Verbo da Vida Zona Leste';
                        igrejaClass = 'igreja-zona-leste';
                        break;
                    case 'estacao':
                        igrejaTexto = 'Verbo da Vida Esta√ß√£o';
                        igrejaClass = 'igreja-estacao';
                        break;
                    default:
                        igrejaTexto = 'N√£o Identificada';
                        igrejaClass = 'igreja-nao-identificada';
                }
                
                // Informa√ß√µes da chave PIX
                let chavePixTexto = '-';
                let chavePixIcon = '';
                if (transacao.chavePixUtilizada && transacao.metodoPagamento === 'PIX') {
                    chavePixTexto = transacao.chavePixUtilizada.chave;
                    if (transacao.chavePixUtilizada.tipo === 'email') chavePixIcon = 'üìß';
                    else if (transacao.chavePixUtilizada.tipo === 'telefone') chavePixIcon = 'üì±';
                }
                
                tr.innerHTML = `
                    <td><span class="situacao-badge ${situacaoClass}">${transacao.situacao}</span></td>
                    <td class="amount ${transacao.tipo === 'credit' ? 'entrada-amount' : 'saida-amount'}">${formatarValor(transacao.valor)}</td>
                    <td>${transacao.dataHora}</td>
                    <td>${transacao.doador}</td>
                    <td><span class="igreja-badge ${igrejaClass}">${igrejaTexto}</span></td>
                    <td><span class="payment-method">${transacao.metodoPagamento}</span></td>
                    <td><span class="identificador">${transacao.identificador}</span></td>
                    <td><span class="id-transacao">${transacao.idTransacao}</span></td>
                    <td>${transacao.observacoes || '-'}</td>
                    <td>${chavePixIcon} ${chavePixTexto}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            if (transactionsCount) {
                transactionsCount.textContent = `Mostrando ${transacoes.length} de ${allTransactions.length} doa√ß√µes`;
            }
        }

        // Atualizar totais filtrados
        function atualizarTotaisFiltrados(transacoes) {
            if (!transacoes || transacoes.length === 0) {
                if (filteredTotalsInfo) {
                    filteredTotalsInfo.style.display = 'none';
                }
                return;
            }
            
            const entradas = transacoes
                .filter(t => t.tipo === 'credit')
                .reduce((sum, t) => sum + t.valor, 0);
            
            const saidas = transacoes
                .filter(t => t.tipo === 'debit')
                .reduce((sum, t) => sum + t.valor, 0);
            
            const saldo = entradas - saidas;
            
            // Atualizar cards
            if (document.querySelector('.card.entrada .value')) {
                document.querySelector('.card.entrada .value').textContent = formatarValor(entradas);
                document.querySelector('.card.entrada p').textContent = 'Entradas (filtradas)';
            }
            
            if (document.querySelector('.card.saida .value')) {
                document.querySelector('.card.saida .value').textContent = formatarValor(saidas);
                document.querySelector('.card.saida p').textContent = 'Sa√≠das (filtradas)';
            }
            
            if (document.querySelector('.card.total .value')) {
                document.querySelector('.card.total .value').textContent = formatarValor(saldo);
                document.querySelector('.card.total p').textContent = 'Saldo (filtrado)';
            }
            
            // Mostrar info de filtros
            if (filteredTotalsInfo && filteredTotalsText) {
                filteredTotalsInfo.style.display = 'block';
                filteredTotalsText.textContent = `Totais calculados com base nos filtros aplicados: ${transacoes.length} doa√ß√µes`;
            }
        }

        // Limpar filtros
        function limparFiltros() {
            // Limpar inputs
            if (tipoSelect) tipoSelect.value = '';
            if (doadorInput) doadorInput.value = '';
            if (tipoDoacaoSelect) tipoDoacaoSelect.value = '';
            if (valorInput) valorInput.value = '';
            if (statusSelect) statusSelect.value = '';
            if (metodoPagamentoSelect) metodoPagamentoSelect.value = '';
            if (igrejaSelect) igrejaSelect.value = '';
            
            // Limpar datas (voltar para √∫ltimos 30 dias)
            const hoje = new Date();
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(hoje.getDate() - 30);
            
            if (dataInicioInput) dataInicioInput.value = trintaDiasAtras.toISOString().split('T')[0];
            if (dataFimInput) dataFimInput.value = hoje.toISOString().split('T')[0];
            
            // Limpar sele√ß√£o de chaves PIX
            chavesPixSelecionadas = [];
            if (pixKeysContainer) {
                pixKeysContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                pixKeysContainer.querySelectorAll('.pix-key-option').forEach(option => {
                    option.classList.remove('selected');
                });
            }
            
            atualizarContadorChavesSelecionadas();
            
            // Recalcular totais gerais
            calcularTotais();
            
            // Aplicar filtros (sem filtros)
            aplicarFiltros();
        }

        // Exportar dados
        function exportarDados() {
            const transacoesParaExportar = filteredTransactions.length > 0 ? filteredTransactions : allTransactions;
            
            if (transacoesParaExportar.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }
            
            let csv = 'Data,Hora,Doador,Valor,Tipo Doa√ß√£o,Igreja,M√©todo Pagamento,Status,Chave PIX,Observa√ß√µes\n';
            
            transacoesParaExportar.forEach(transacao => {
                const [data, hora] = transacao.dataHora.split(' ');
                const chavePix = transacao.chavePixUtilizada ? transacao.chavePixUtilizada.chave : '-';
                const tipoDoacaoTexto = transacao.tipoDoacao === 'dizimo' ? 'D√≠zimo' : 
                                      transacao.tipoDoacao === 'oferta' ? 'Oferta' : 'Outro';
                
                const linha = [
                    data,
                    hora,
                    `"${transacao.doador}"`,
                    transacao.valor.toFixed(2),
                    tipoDoacaoTexto,
                    transacao.igreja,
                    transacao.metodoPagamento,
                    transacao.situacao,
                    chavePix,
                    `"${transacao.observacoes || ''}"`
                ].join(',');
                
                csv += linha + '\n';
            });
            
            // Criar e baixar arquivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `doacoes-verbo-da-vida-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Dados exportados com sucesso! ${transacoesParaExportar.length} registros.`);
        }

        // Event listeners
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const usuario = usernameInput.value.trim();
            const senha = passwordInput.value;
            
            if (fazerLogin(usuario, senha)) {
                loginError.style.display = 'none';
                loginScreen.style.display = 'none';
                mainSystem.style.display = 'block';
                
                // Inicializar o sistema
                buscarMovimentos();
            } else {
                loginError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            usernameInput.focus();
            
            // Configurar datas iniciais
            const hoje = new Date();
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(hoje.getDate() - 30);
            
            if (dataInicioInput) dataInicioInput.value = trintaDiasAtras.toISOString().split('T')[0];
            if (dataFimInput) dataFimInput.value = hoje.toISOString().split('T')[0];
            
            console.log('üöÄ Sistema inicializado para buscar DADOS REAIS do Mercado Pago');
            console.log('üîë Token:', ACCESS_TOKEN.substring(0, 20) + '...');
            console.log('üë§ Use as credenciais: admin / verbo2025');
        });

        // Adicionar event listeners para os bot√µes (se os elementos existirem)
        document.addEventListener('DOMContentLoaded', function() {
            // Aguardar um pouco para garantir que o DOM est√° carregado
            setTimeout(() => {
                // Bot√£o Aplicar Filtros
                const aplicarFiltrosBtn = document.getElementById('aplicar-filtros');
                if (aplicarFiltrosBtn) {
                    aplicarFiltrosBtn.addEventListener('click', aplicarFiltros);
                }
                
                // Bot√£o Limpar Filtros
                const limparFiltrosBtn = document.getElementById('limpar-filtros');
                if (limparFiltrosBtn) {
                    limparFiltrosBtn.addEventListener('click', limparFiltros);
                }
                
                // Bot√£o Atualizar Dados
                const atualizarDadosBtn = document.getElementById('atualizar-dados');
                if (atualizarDadosBtn) {
                    atualizarDadosBtn.addEventListener('click', buscarMovimentos);
                }
                
                // Bot√£o Exportar Dados
                const exportarDadosBtn = document.getElementById('exportar-dados');
                if (exportarDadosBtn) {
                    exportarDadosBtn.addEventListener('click', exportarDados);
                }
                
                // Bot√£o Refresh PIX Keys
                const refreshPixKeysBtn = document.getElementById('refresh-pix-keys');
                if (refreshPixKeysBtn) {
                    refreshPixKeysBtn.addEventListener('click', async function() {
                        try {
                            refreshPixKeysBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
                            refreshPixKeysBtn.disabled = true;
                            
                            await buscarMinhasChavesPix();
                            
                            refreshPixKeysBtn.innerHTML = '<i class="fas fa-redo"></i> Atualizar Chaves';
                            refreshPixKeysBtn.disabled = false;
                        } catch (error) {
                            console.error('Erro ao atualizar chaves PIX:', error);
                            refreshPixKeysBtn.innerHTML = '<i class="fas fa-redo"></i> Atualizar Chaves';
                            refreshPixKeysBtn.disabled = false;
                        }
                    });
                }
            }, 100);
        });

    </script>
</body>
</html>
