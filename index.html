<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de D√≠zimos e Ofertas - Verbo da Vida</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* PALETA DE CORES ATUALIZADA - TEMA AZUL PROFISSIONAL PARA IGREJA */
        :root { 
            --primary: #1a4b8c; 
            --primary-light: #2a6fd6; 
            --secondary: #f9c80e; 
            --success: #28a745; 
            --danger: #dc3545; 
            --light: #f8f9fa; 
            --dark: #343a40; 
            --gray: #6c757d; 
            --border: #dee2e6; 
            --accent: #17a2b8;
            --estacao: #fd7e14; /* Cor Laranja para Esta√ß√£o */
            --roxo-pix: #32bcad; /* Cor oficial do PIX */
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8f9fa; color: var(--dark); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* TELA DE LOGIN */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
        }
        
        .login-container {
            background: white;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-logo img { height: 80px; margin-bottom: 15px; }
        .login-logo h1 { font-size: 1.5rem; color: var(--dark); margin-bottom: 5px; }
        .login-logo p { color: var(--gray); font-size: 0.9rem; }
        
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .form-group input { width: 100%; padding: 12px 15px; border: 1px solid var(--border); border-radius: 5px; font-size: 1rem; transition: border-color 0.3s; }
        .form-group input:focus { border-color: var(--primary); outline: none; }
        
        .login-btn {
            width: 100%; padding: 12px; background-color: var(--primary); color: white;
            border: none; border-radius: 5px; font-size: 1rem; font-weight: 500;
            cursor: pointer; transition: background-color 0.3s; margin-top: 10px;
        }
        .login-btn:hover { background-color: var(--primary-light); }
        
        .login-error {
            background-color: rgba(220, 53, 69, 0.1); color: var(--danger); padding: 10px;
            border-radius: 5px; margin-top: 15px; font-size: 0.9rem; display: none;
        }
        
        /* HEADER ATUALIZADO */
        header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
            color: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 30px; border-bottom: 4px solid var(--secondary);
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo img { height: 50px; }
        .logo h1 { font-size: 1.8rem; font-weight: 600; }
        
        .church-selector { display: flex; gap: 10px; flex-wrap: wrap; }
        .church-btn { 
            padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 5px; 
            font-size: 0.9rem; cursor: pointer; transition: all 0.3s;
        }
        .church-btn.active { background: var(--secondary); color: var(--dark); font-weight: 600; }
        
        /* CARDS DO DASHBOARD */
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { 
            background: white; border-radius: 10px; padding: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.3s ease; 
            border-top: 4px solid var(--primary);
        }
        .card:hover { transform: translateY(-5px); }
        .card h3 { font-size: 0.9rem; color: var(--gray); margin-bottom: 10px; }
        .card .value { font-size: 1.8rem; font-weight: 700; }
        .card.entrada .value { color: var(--success); }
        .card.saida .value { color: var(--danger); }
        .card.total .value { color: var(--primary); }
        
        /* SE√á√ÉO DE FILTROS */
        .filters { 
            background: white; border-radius: 10px; padding: 20px; margin-bottom: 30px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 4px solid var(--primary);
        }
        .filter-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--gray); }
        .filter-group input, .filter-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 5px; font-size: 1rem; }
        .filter-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        
        /* BOT√ïES */
        button { 
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; 
            font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-light); }
        .btn-secondary { background-color: var(--light); color: var(--dark); }
        .btn-secondary:hover { background-color: #e0e0e0; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-church { background-color: var(--accent); color: white; }
        
        /* TABELA DE TRANSA√á√ïES */
        .transactions { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .transactions-header { 
            padding: 15px 20px; background-color: var(--light); border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .transactions-header h2 { font-size: 1.2rem; font-weight: 600; }
        .transactions-count { color: var(--gray); font-size: 0.9rem; }
        table { width: 100%; border-collapse: collapse; }
        thead { background-color: var(--light); }
        th { padding: 15px 20px; text-align: left; font-weight: 600; color: var(--gray); border-bottom: 1px solid var(--border); }
        td { padding: 15px 20px; border-bottom: 1px solid var(--border); }
        tbody tr:hover { background-color: rgba(26, 75, 140, 0.05); }
        
        /* BADGES */
        .situacao-badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .situacao-aprovado { background-color: rgba(40, 167, 69, 0.1); color: var(--success); }
        .situacao-pendente { background-color: rgba(255, 193, 7, 0.1); color: #ffc107; }
        .situacao-cancelado { background-color: rgba(220, 53, 69, 0.1); color: var(--danger); }
        
        .amount { font-weight: 600; }
        .entrada-amount { color: var(--success); }
        .saida-amount { color: var(--danger); }
        
        /* NOVAS BADGES DE IGREJA E PIX */
        .igreja-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .igreja-inga { background-color: rgba(26, 75, 140, 0.1); color: var(--primary); }
        .igreja-zona-leste { background-color: rgba(23, 162, 184, 0.1); color: var(--accent); }
        .igreja-estacao { background-color: rgba(253, 126, 20, 0.1); color: var(--estacao); } /* Laranja */
        .igreja-nao-identificada { background-color: rgba(108, 117, 125, 0.1); color: var(--gray); }

        .chave-pix-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;
            background-color: rgba(50, 188, 173, 0.1); color: #208e80; border: 1px solid rgba(50, 188, 173, 0.2);
        }
        
        /* ESTILOS DE ESTADO */
        .loading { text-align: center; padding: 40px; color: var(--gray); }
        .loading i { font-size: 2rem; margin-bottom: 10px; }
        .error, .success { padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid; }
        .error { background-color: rgba(220, 53, 69, 0.1); color: var(--danger); border-color: var(--danger); }
        .success { background-color: rgba(40, 167, 69, 0.1); color: var(--success); border-color: var(--success); }
        
        /* ABAS */
        .tabs { display: flex; margin-bottom: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 15px 20px; text-align: center; cursor: pointer; transition: all 0.3s; font-weight: 500; border-bottom: 3px solid transparent; }
        .tab.active { background-color: var(--primary); color: white; border-bottom: 3px solid var(--secondary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* NOVO ESTILO PARA O FILTRO DE CHAVES PIX INTELIGENTE */
        .pix-filter-section {
            background-color: rgba(50, 188, 173, 0.05);
            border-radius: 8px; padding: 15px; margin-top: 15px;
            border-left: 4px solid var(--roxo-pix);
        }
        .pix-filter-section h4 { color: #208e80; margin-bottom: 10px; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        
        .key-tag {
            font-family: monospace; background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; color: #495057;
        }

        @media (max-width: 768px) { 
            .header-content { flex-direction: column; gap: 15px; } 
            .dashboard-cards { grid-template-columns: 1fr; } 
            table { display: block; overflow-x: auto; } 
            .filter-actions { justify-content: center; flex-wrap: wrap; }
            .filter-actions button { flex: 1; min-width: 120px; }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <img src="https://nekbbkenxcukoortusge.supabase.co/storage/v1/object/public/imagens2/produtos/logo.png" alt="Verbo da Vida">
                <h1>Sistema de D√≠zimos e Ofertas</h1>
                <p>Acesso Financeiro Centralizado</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usu√°rio</label>
                    <input type="text" id="username" placeholder="Digite seu usu√°rio" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha" required>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-triangle"></i> Usu√°rio ou senha incorretos
                </div>
            </form>
        </div>
    </div>
    
    <div id="mainSystem" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <img src="https://nekbbkenxcukoortusge.supabase.co/storage/v1/object/public/imagens2/produtos/logo.png" alt="Verbo da Vida">
                        <div>
                            <h1>Controle Financeiro</h1>
                            <p>Gest√£o por Chaves PIX</p>
                        </div>
                    </div>
                    <div class="church-selector">
                        <div class="church-btn active" data-church="todas">Todas</div>
                        <div class="church-btn" data-church="inga">Ing√°</div>
                        <div class="church-btn" data-church="zona-leste">Zona Leste</div>
                        <div class="church-btn" data-church="estacao">Esta√ß√£o</div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="container">
            <div class="tabs">
                <div class="tab active" data-tab="dashboard">Dashboard e Filtros</div>
                <div class="tab" data-tab="historico">Hist√≥rico Mensal</div>
            </div>
            
            <div class="tab-content active" id="dashboard-content">
                
                <div class="dashboard-cards">
                    <div class="card entrada">
                        <h3>Total de Entradas</h3>
                        <div class="value">R$ 0,00</div>
                        <p>Filtrado</p>
                    </div>
                    <div class="card saida">
                        <h3>Total de Sa√≠das</h3>
                        <div class="value">R$ 0,00</div>
                        <p>Filtrado</p>
                    </div>
                    <div class="card total">
                        <h3>Saldo Geral (Conta)</h3>
                        <div class="value">R$ 0,00</div>
                        <p>Dispon√≠vel no Mercado Pago</p>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="data-inicio">Data In√≠cio</label>
                            <input type="date" id="data-inicio">
                        </div>
                        <div class="filter-group">
                            <label for="data-fim">Data Fim</label>
                            <input type="date" id="data-fim">
                        </div>
                        <div class="filter-group">
                            <label for="tipo">Tipo Movimento</label>
                            <select id="tipo">
                                <option value="">Todos</option>
                                <option value="credit">Entrada (Cr√©dito)</option>
                                <option value="debit">Sa√≠da (D√©bito)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="pix-filter-section">
                        <h4><i class="fas fa-qrcode"></i> Filtro por Chave PIX (Igreja de Destino)</h4>
                        <div class="filter-row">
                            <div class="filter-group" style="flex: 2;">
                                <label for="chave-pix-filtro">Selecionar Chave de Destino:</label>
                                <select id="chave-pix-filtro" style="border: 2px solid var(--roxo-pix); color: var(--dark);">
                                    <option value="">Todas as Chaves / Igrejas</option>
                                    <option value="83991993505">Ing√° - üì± 83991993505</option>
                                    <option value="83996116614">Zona Leste - üì± 83996116614</option>
                                    <option value="financeiro@verboestacao.com">Esta√ß√£o - üìß financeiro@verboestacao.com</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status da L√≥gica:</label>
                                <div style="font-size: 0.8rem; color: #208e80; padding-top: 5px;">
                                    <i class="fas fa-check-circle"></i> Mapeamento Ativo
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-row" style="margin-top: 15px;">
                        <div class="filter-group">
                            <label for="doador">Buscar (Nome/Descri√ß√£o)</label>
                            <input type="text" id="doador" placeholder="Ex: Jo√£o, D√≠zimo...">
                        </div>
                        <div class="filter-group">
                            <label for="metodo-pagamento">M√©todo</label>
                            <select id="metodo-pagamento">
                                <option value="">Todos</option>
                                <option value="PIX">PIX</option>
                                <option value="Cart√£o">Cart√£o</option>
                                <option value="Dinheiro">Dinheiro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn-secondary" id="limpar-filtros">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                        <button class="btn-primary" id="aplicar-filtros">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        <button class="btn-success" id="atualizar-dados">
                            <i class="fas fa-sync-alt"></i> Atualizar API
                        </button>
                        <button class="btn-church" id="exportar-dados">
                            <i class="fas fa-file-csv"></i> Exportar CSV
                        </button>
                    </div>
                </div>
                
                <div class="transactions">
                    <div class="transactions-header">
                        <h2>Extrato de Doa√ß√µes</h2>
                        <div class="transactions-count">Carregando...</div>
                    </div>
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Conectando ao Mercado Pago...</p>
                    </div>
                    <table style="display: none;">
                        <thead>
                            <tr>
                                <th>Situa√ß√£o</th>
                                <th>Valor</th>
                                <th>Data</th>
                                <th>Doador/Descri√ß√£o</th>
                                <th>Igreja (Destino)</th>
                                <th>Chave PIX Usada</th>
                                <th>ID Transa√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="historico-content">
                <div class="filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Ano de Refer√™ncia</label>
                            <select id="ano-filtro">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn-primary" id="carregar-historico" style="margin-top: 25px;">
                                <i class="fas fa-chart-bar"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>
                <div id="historico-resultado" class="transactions">
                    <div class="loading" style="display:none;">
                        <i class="fas fa-spinner fa-spin"></i> Gerando hist√≥rico...
                    </div>
                    <table id="tabela-historico" style="display: none;">
                        <thead>
                            <tr>
                                <th>M√™s</th>
                                <th>Entradas</th>
                                <th>Sa√≠das</th>
                                <th>Saldo do M√™s</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <footer>
            <div class="container" style="text-align: center; color: var(--gray); font-size: 0.8rem; margin-top: 30px;">
                <p>Sistema Verbo da Vida - Integra√ß√£o Mercado Pago API v2.0</p>
                <p>Filtros de Chave Pix: Ing√° | Zona Leste | Esta√ß√£o</p>
            </div>
        </footer>
    </div>

    <script>
        // CONFIGURA√á√ïES E CONSTANTES
        const ACCESS_TOKEN = 'APP_USR-7942402403468023-112215-a0799e629a61e1568f394d40728fed58-674529245'; // Token do Usu√°rio
        const API_BASE_URL = 'https://api.mercadopago.com';

        // *** O CORA√á√ÉO DO SISTEMA: MAPEAMENTO DAS CHAVES ***
        // Definimos aqui a verdade absoluta sobre qual chave pertence a qual igreja
        const MAPA_CHAVES = {
            '83991993505': { 
                id: 'inga', 
                nome: 'Verbo da Vida Ing√°', 
                badgeClass: 'igreja-inga',
                tipo: 'Celular'
            },
            '83996116614': { 
                id: 'zona-leste', 
                nome: 'Verbo da Vida Zona Leste', 
                badgeClass: 'igreja-zona-leste',
                tipo: 'Celular'
            },
            'financeiro@verboestacao.com': { 
                id: 'estacao', 
                nome: 'Verbo da Vida Esta√ß√£o', 
                badgeClass: 'igreja-estacao',
                tipo: 'E-mail'
            }
        };

        // Elementos DOM
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');
        const loginForm = document.getElementById('loginForm');
        
        // Dados Globais
        let allTransactions = [];
        let filteredTransactions = [];
        let saldoGeral = 0;

        // Login Simulado
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            // Login simples para demonstra√ß√£o
            if(u.toLowerCase() === 'admin' || u.toLowerCase() === 'financeiro') {
                loginScreen.style.display = 'none';
                mainSystem.style.display = 'block';
                iniciarSistema();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        function iniciarSistema() {
            // Define datas padr√£o (√∫ltimos 30 dias)
            const hoje = new Date();
            const mesPassado = new Date();
            mesPassado.setDate(hoje.getDate() - 30);
            
            document.getElementById('data-inicio').value = mesPassado.toISOString().split('T')[0];
            document.getElementById('data-fim').value = hoje.toISOString().split('T')[0];

            buscarDadosAPI();
        }

        // --- FUN√á√ïES DE L√ìGICA DE NEG√ìCIO (A "M√ÅGICA") ---

        /**
         * Tenta descobrir qual Chave PIX foi usada e qual Igreja √© a dona.
         * Como a API √†s vezes esconde o destinat√°rio exato em transa√ß√µes simples,
         * usamos uma l√≥gica de infer√™ncia baseada em padr√µes.
         */
        function classificarTransacao(item) {
            const descricao = (item.description || '').toLowerCase();
            const obs = (item.call_for_payment_id || '').toLowerCase(); // √Äs vezes tem info aqui
            const metadata = JSON.stringify(item.metadata || {}).toLowerCase();
            
            // 1. Tentar encontrar a chave EXATA nos dados (Raro, mas acontece em QR Codes)
            for (let chave in MAPA_CHAVES) {
                if (descricao.includes(chave) || metadata.includes(chave)) {
                    return { chave: chave, ...MAPA_CHAVES[chave] };
                }
            }

            // 2. Infer√™ncia por Texto (Se o usu√°rio escreveu "Ing√°" ou "Oferta Zona Leste")
            // Isso tamb√©m serve como "Retro-atribui√ß√£o" da chave correta
            if (descricao.includes('inga') || descricao.includes('ing√°')) {
                return { chave: '83991993505', ...MAPA_CHAVES['83991993505'] }; // For√ßa a chave do Ing√°
            }
            if (descricao.includes('zona leste') || descricao.includes('leste') || descricao.includes('zl')) {
                return { chave: '83996116614', ...MAPA_CHAVES['83996116614'] }; // For√ßa a chave da ZL
            }
            if (descricao.includes('estacao') || descricao.includes('esta√ß√£o') || descricao.includes('centro')) {
                return { chave: 'financeiro@verboestacao.com', ...MAPA_CHAVES['financeiro@verboestacao.com'] };
            }

            // 3. Padr√£o (N√£o Identificado)
            return {
                chave: null,
                id: 'nao-identificada',
                nome: 'N√£o Identificada',
                badgeClass: 'igreja-nao-identificada'
            };
        }

        // --- INTEGRA√á√ÉO API ---

        async function fazerRequisicao(url) {
            try {
                const response = await fetch(url, {
                    headers: { 
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error(`Erro API: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        async function buscarDadosAPI() {
            const loading = document.querySelector('.loading');
            const table = document.querySelector('table');
            const tbody = document.querySelector('tbody');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            tbody.innerHTML = '';

            const dtInicio = document.getElementById('data-inicio').value;
            const dtFim = document.getElementById('data-fim').value;

            // Busca Saldo
            try {
                const saldoData = await fazerRequisicao(`${API_BASE_URL}/v1/users/me/mercadopago_account/balance`);
                if(saldoData) {
                    saldoGeral = saldoData.total_amount || 0;
                    document.querySelector('.card.total .value').textContent = formatarMoeda(saldoGeral);
                }
            } catch (e) { console.log('Erro saldo', e); }

            // Busca Pagamentos
            const url = `${API_BASE_URL}/v1/payments/search?sort=date_created&criteria=desc&limit=500&range=date_created&begin_date=${dtInicio}T00:00:00Z&end_date=${dtFim}T23:59:59Z`;
            
            const dados = await fazerRequisicao(url);

            if (dados && dados.results) {
                processarTransacoes(dados.results);
            } else {
                tbody.innerHTML = '<tr><td colspan="7">Erro ao carregar dados ou sem dados no per√≠odo.</td></tr>';
                table.style.display = 'table';
                loading.style.display = 'none';
            }
        }

        function processarTransacoes(apiData) {
            allTransactions = apiData.map(t => {
                const infoIgreja = classificarTransacao(t);
                
                // Formata√ß√£o de data
                const data = new Date(t.date_created);
                const dataFormatada = data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

                // M√©todo
                let metodo = 'Outro';
                if (t.payment_method_id === 'pix') metodo = 'PIX';
                else if (t.payment_method_id.includes('card')) metodo = 'Cart√£o';
                else if (t.payment_method_id === 'account_money') metodo = 'Saldo MP';

                return {
                    id: t.id,
                    status: t.status, // approved, pending, rejected
                    statusDetail: t.status_detail,
                    tipo: (t.status_detail === 'accredited' || t.operation_type === 'regular_payment') ? 'credit' : 'debit',
                    valor: t.transaction_amount,
                    data: dataFormatada,
                    rawDate: t.date_created,
                    descricao: t.description || 'Sem descri√ß√£o',
                    doador: t.payer?.email || 'An√¥nimo',
                    igreja: infoIgreja, // Objeto completo com chave e nome
                    metodo: metodo
                };
            });

            aplicarFiltros();
        }

        // --- RENDERIZA√á√ÉO E FILTROS ---

        function aplicarFiltros() {
            const tipoFiltro = document.getElementById('tipo').value;
            const chaveFiltro = document.getElementById('chave-pix-filtro').value; // O Filtro Principal
            const buscaFiltro = document.getElementById('doador').value.toLowerCase();
            const metodoFiltro = document.getElementById('metodo-pagamento').value;
            
            // Filtro por bot√µes de atalho (cabe√ßalho)
            const btnIgrejaAtivo = document.querySelector('.church-btn.active').dataset.church;

            filteredTransactions = allTransactions.filter(t => {
                // 1. Filtro Tipo (Entrada/Sa√≠da)
                if (tipoFiltro && t.tipo !== tipoFiltro) return false;

                // 2. Filtro de Chave PIX (Select Espec√≠fico)
                if (chaveFiltro) {
                    // Se o item n√£o tiver chave identificada ou a chave for diferente
                    if (!t.igreja.chave || t.igreja.chave !== chaveFiltro) return false;
                }

                // 3. Filtro de Igreja (Bot√µes do Header) - Sincroniza com as chaves
                if (btnIgrejaAtivo !== 'todas') {
                    if (t.igreja.id !== btnIgrejaAtivo) return false;
                }

                // 4. Busca Texto
                if (buscaFiltro && !t.descricao.toLowerCase().includes(buscaFiltro) && !t.doador.toLowerCase().includes(buscaFiltro)) return false;

                // 5. M√©todo
                if (metodoFiltro && t.metodo !== metodoFiltro) return false;

                return true;
            });

            renderizarTabela();
            atualizarCards();
        }

        function renderizarTabela() {
            const tbody = document.querySelector('tbody');
            const loading = document.querySelector('.loading');
            const table = document.querySelector('table');
            const countDiv = document.querySelector('.transactions-count');

            loading.style.display = 'none';
            table.style.display = 'table';
            tbody.innerHTML = '';

            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Nenhum registro encontrado para este filtro.</td></tr>';
                countDiv.textContent = '0 registros';
                return;
            }

            countDiv.textContent = `${filteredTransactions.length} registros encontrados`;

            filteredTransactions.forEach(t => {
                const tr = document.createElement('tr');
                
                // Badge Situa√ß√£o
                let sitClass = 'situacao-pendente';
                let sitLabel = 'Pendente';
                if(t.status === 'approved') { sitClass = 'situacao-aprovado'; sitLabel = 'Aprovado'; }
                else if(t.status === 'cancelled' || t.status === 'rejected') { sitClass = 'situacao-cancelado'; sitLabel = 'Cancelado'; }

                // Valor Class
                const valorClass = t.tipo === 'credit' ? 'entrada-amount' : 'saida-amount';
                const sinal = t.tipo === 'credit' ? '+' : '-';

                // Renderiza a c√©lula da Chave Pix com formata√ß√£o bonita
                let pixCell = '<span style="color: #ccc;">-</span>';
                if (t.igreja.chave) {
                    pixCell = `<div class="chave-pix-badge"><i class="fas fa-key"></i> ${t.igreja.chave}</div>`;
                } else if (t.metodo === 'PIX') {
                    pixCell = '<span style="font-size:0.8rem; color: orange;">N√£o identificado</span>';
                }

                tr.innerHTML = `
                    <td><span class="situacao-badge ${sitClass}">${sitLabel}</span></td>
                    <td class="amount ${valorClass}">${sinal} ${formatarMoeda(t.valor)}</td>
                    <td>${t.data}</td>
                    <td>
                        <div style="font-weight:600;">${t.descricao}</div>
                        <div style="font-size:0.8rem; color:gray;">${t.doador}</div>
                    </td>
                    <td><span class="igreja-badge ${t.igreja.badgeClass}">${t.igreja.nome}</span></td>
                    <td>${pixCell}</td>
                    <td style="font-family:monospace; font-size:0.8rem;">${t.id}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function atualizarCards() {
            const entradas = filteredTransactions.filter(t => t.tipo === 'credit' && t.status === 'approved').reduce((acc, t) => acc + t.valor, 0);
            const saidas = filteredTransactions.filter(t => t.tipo === 'debit' && t.status === 'approved').reduce((acc, t) => acc + t.valor, 0);
            
            document.querySelector('.card.entrada .value').textContent = formatarMoeda(entradas);
            document.querySelector('.card.saida .value').textContent = formatarMoeda(saidas);
        }

        function formatarMoeda(val) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        }

        // --- EVENT LISTENERS ---

        document.getElementById('aplicar-filtros').addEventListener('click', aplicarFiltros);
        document.getElementById('atualizar-dados').addEventListener('click', buscarDadosAPI);
        document.getElementById('limpar-filtros').addEventListener('click', () => {
            document.getElementById('chave-pix-filtro').value = "";
            document.getElementById('doador').value = "";
            document.getElementById('tipo').value = "";
            document.querySelector('.church-btn.active').classList.remove('active');
            document.querySelector('.church-btn[data-church="todas"]').classList.add('active');
            iniciarSistema();
        });

        // Tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
                t.classList.add('active');
                document.getElementById(`${t.dataset.tab}-content`).classList.add('active');
            });
        });

        // Bot√µes de Igreja (Header)
        document.querySelectorAll('.church-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.church-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Sincroniza o Select de Chave Pix com o Bot√£o
                const mapaReverso = {
                    'inga': '83991993505',
                    'zona-leste': '83996116614',
                    'estacao': 'financeiro@verboestacao.com',
                    'todas': ''
                };
                document.getElementById('chave-pix-filtro').value = mapaReverso[btn.dataset.church];
                
                aplicarFiltros();
            });
        });

        // Sincroniza o Select de Chave Pix AO CONTR√ÅRIO (se mudar o select, muda o bot√£o)
        document.getElementById('chave-pix-filtro').addEventListener('change', (e) => {
            const val = e.target.value;
            const mapa = {
                '83991993505': 'inga',
                '83996116614': 'zona-leste',
                'financeiro@verboestacao.com': 'estacao',
                '': 'todas'
            };
            const churchId = mapa[val] || 'todas';
            document.querySelectorAll('.church-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.church-btn[data-church="${churchId}"]`).classList.add('active');
            aplicarFiltros();
        });

        // Exportar CSV
        document.getElementById('exportar-dados').addEventListener('click', () => {
            let csv = 'Data,Descricao,Valor,Tipo,Status,Igreja,ChavePix\n';
            filteredTransactions.forEach(t => {
                csv += `${t.data},"${t.descricao}",${t.valor.toFixed(2)},${t.tipo},${t.status},"${t.igreja.nome}","${t.igreja.chave || ''}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio_financeiro_verbo.csv';
            a.click();
        });

    </script>
</body>
</html>
